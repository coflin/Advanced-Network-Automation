import csv
from netmiko import ConnectHandler
from rich.console import Console
from rich.table import Table
from InquirerPy import prompt  # For user input

console = Console()

def sshInfo():
    try:
        csv_file = "sshInfo.csv"
        data = {}

        with open(csv_file, "r") as file:
            reader = csv.DictReader(file)
            for row in reader:
                router_name = row["Routers"]
                router_data = {
                    "Device_Type": row["Device_Type"],
                    "IP": row["IP"],
                    "Username": row["Username"],
                    "Password": row["Password"]
                }
                data[router_name] = router_data

        return data

    except Exception as e:
        console.log(f"[bold red]Unable to open sshInfo.csv file: {e}[/bold red]")
        return None

def execute_ssh_command(ip, username, password, command):
    device = {
        'device_type': 'arista_eos',
        'ip': ip,
        'username': username,
        'password': password,
    }

    try:
        net_connect = ConnectHandler(**device)
        net_connect.enable()  # Enter enable mode
        output = net_connect.send_command(command)
        return output
    except Exception as e:
        return f"[bold red]Failed to connect to {ip}: {e}[/bold red]"

def get_health_info(device):
    ip = ssh_data[device]['IP']
    username = ssh_data[device]['Username']
    password = ssh_data[device]['Password']

    # Health check commands
    commands = {
        "CPU Usage": "show processes top once | grep CPU",
        "OSPF Neighborships": "show ip ospf neighbor",
        "BGP Neighborships": "show ip bgp summary",
        "Route Table": "show ip route",
        "IP Connectivity": "ping 192.168.100.1"
    }

    console.rule(f"[bold cyan]Health Check for {device} ({ip})[/bold cyan]")
    table = Table(show_header=True, header_style="bold magenta")
    table.add_column("Check")
    table.add_column("Result")

    # CPU Usage
    result = execute_ssh_command(ip, username, password, commands["CPU Usage"])
    table.add_row(f"[bold yellow]CPU Usage[/bold yellow]", result.strip())

    # OSPF Neighborships
    result = execute_ssh_command(ip, username, password, commands["OSPF Neighborships"])
    if "neighbor" in result.lower():
        table.add_row(f"[bold yellow]OSPF Neighborships[/bold yellow]", result.strip())
    else:
        table.add_row(f"[bold yellow]OSPF Neighborships[/bold yellow]", "[bold red]OSPF is not configured[/bold red]")

    # BGP Neighborships
    result = execute_ssh_command(ip, username, password, commands["BGP Neighborships"])
    if "bgp" in result.lower():
        table.add_row(f"[bold yellow]BGP Neighborships[/bold yellow]", result.strip())
    else:
        table.add_row(f"[bold yellow]BGP Neighborships[/bold yellow]", "[bold red]BGP is not configured[/bold red]")

    # Route Table (Filtered)
    route_output = execute_ssh_command(ip, username, password, commands["Route Table"])
    if "Gateway of last resort" in route_output:
        start_index = route_output.find("Gateway of last resort")
        filtered_route_output = route_output[start_index:]
        table.add_row(f"[bold yellow]Route Table[/bold yellow]", filtered_route_output.strip())
    else:
        table.add_row(f"[bold yellow]Route Table[/bold yellow]", "[bold red]No route table available[/bold red]")

    # IP Connectivity
    result = execute_ssh_command(ip, username, password, commands["IP Connectivity"])
    table.add_row(f"[bold yellow]IP Connectivity[/bold yellow]", result.strip())

    console.print(table)  # Print the table once at the end
    console.print("\n[bold cyan]------------------------------------------------------[/bold cyan]\n")


if __name__ == "__main__":
    ssh_data = sshInfo()
    if ssh_data:
        # Loop to continuously ask for input until the user quits
        while True:
            devices = list(ssh_data.keys()) + ["Quit"]  # Add 'Quit' as an option
            questions = [
                {
                    "type": "list",
                    "name": "device_choice",
                    "message": "Choose the device you want to check or quit:",
                    "choices": devices
                }
            ]
            answers = prompt(questions)
            selected_device = answers['device_choice']

            if selected_device == "Quit":
                console.print("[bold green]Exiting the health check tool.[/bold green]")
                break
            else:
                get_health_info(selected_device)

